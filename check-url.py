#!/usr/bin/env python

import sys
from elasticsearch import Elasticsearch
import requests

es = Elasticsearch(['http://elastic:changeme@localhost:9200'])

res = es.search(index="cve-references", doc_type='ref', scroll='5m',
size=10, body={"query": {"match_all": {}}})

sid = res['_scroll_id']
scroll_size = res['hits']['total']
total_size = res['hits']['total']

current = 0

while(scroll_size > 0):

    for hit in res['hits']['hits']:

        path = hit['_source']['href']

        try:
            print("(%d/%d) Checking %s" % (current, total_size, path))
            current = current + 1
            r = requests.head(path, timeout=10)
            status = r.status_code
        except requests.ConnectionError:
            status = 0
            print("%s failed" % path)
        except requests.exceptions.InvalidSchema:
            status = 0
            print("%s failed" % path)
        except requests.exceptions.ReadTimeout:
            status = 0
            print("%s failed" % path)

        es.update(index="cve-references", id=hit['_id'], doc_type='ref',
                    body={"doc": {"status_code": status}})
        print(status)

    res = es.scroll(scroll_id = sid, scroll = '5m')
    # Update the scroll ID
    sid = res['_scroll_id']
    scroll_size = len(res['hits']['hits'])
