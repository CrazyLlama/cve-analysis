#!/usr/bin/env python3

import sys
import json
from elasticsearch import Elasticsearch

es = Elasticsearch(['http://localhost:9200'])

def main():

    if len(sys.argv) > 1:
        input_file = sys.argv[1]
    else:
        print("Usage: %s <nvd-xml-file>" % (sys.argv[0]))
        sys.exit(1)

    # First let's see if the index exists
    if es.indices.exists('cve-index') is False:
        # We have to create it and add a mapping
        fh = open('cve-index-json-mapping.json')
        mapping = json.load(fh)
        es.indices.create('cve-index', body=mapping)

    fh = open(input_file)
    json_data = json.load(fh)

    for i in json_data['CVE_Items']:

        # ['CVE_Items'][0]['cve']['CVE_data_meta']['ID']
        cve = i['cve']
        cve_id = cve['CVE_data_meta']['ID']
        cve.update(i['impact'])
        cve['year'] = cve_id.split('-')[1]
        es.update(id=cve_id, index="cve-index", body={'doc' : cve, 'doc_as_upsert': True})

if __name__ == "__main__":
    main()
